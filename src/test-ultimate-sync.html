<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Ultimatnej Synchronizacji</title>
    <style>
        body { font-family: Arial, sans-serif; background: #000; color: #fff; padding: 20px; }
        .nav-menu { list-style: none; display: flex; gap: 20px; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .nav-menu li { font-weight: bold; }
        button { background: #00ff00; color: #000; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .section { background: #222; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .debug-output { background: #111; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #00ff00; font-family: monospace; white-space: pre-wrap; }
        .highlight-mismatch { background: #660000 !important; border-left-color: #ff0000 !important; }
    </style>
</head>
<body>
    <h1>üîß Test Ultimatnej Synchronizacji Planu</h1>
    
    <div class="section">
        <h3>üìã Nawigacja (kopia z baza_cv_new.html):</h3>
        <nav>
            <ul class="nav-menu">
                <li>üè† Strona g≈Ç√≥wna</li>
                <li>üíº Oferty pracy</li>
                <li>üìû Kontakt</li>
                <li id="userWelcome" style="color: #00ff00; font-weight: bold;">BRAK DANYCH</li>
                <li id="userPlan" style="color: #00fff7; font-weight: bold; margin-left: 1rem;">BRAK DANYCH</li>
            </ul>
        </nav>
    </div>
    
    <div class="section">
        <h3>üß™ Panel Testowy:</h3>
        <button onclick="testUltimateSync('Premium')">Ustaw Premium ‚≠ê</button>
        <button onclick="testUltimateSync('Business')">Ustaw Business üè¢</button>
        <button onclick="testUltimateSync('Enterprise')">Ustaw Enterprise üíé</button>
        <br>
        <button onclick="createMismatch()">‚ö†Ô∏è Stw√≥rz Niezgodno≈õƒá</button>
        <button onclick="forcePlanSync()">üîÑ Ultimatna Synchronizacja</button>
        <button onclick="debugUserState()">üîç Debug</button>
        <button onclick="clearData()">üóëÔ∏è Wyczy≈õƒá</button>
    </div>
    
    <div class="section">
        <h3>üìä Live Monitor:</h3>
        <div id="liveMonitor" class="debug-output">Monitoring...</div>
    </div>
    
    <div class="section">
        <h3>üîç Wykryte Niezgodno≈õci:</h3>
        <div id="mismatchLog" class="debug-output">Brak niezgodno≈õci</div>
    </div>

    <script>
        // Copy ultimatePlanSync function from baza_cv_new.html
        function ultimatePlanSync() {
            console.log('üöÄ ULTIMATE PLAN SYNC: Starting complete synchronization...');
            log('üöÄ ULTIMATE PLAN SYNC: Starting...');
            
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                console.log('‚ùå ULTIMATE SYNC: No user data found');
                const userInfo = document.getElementById('userWelcome');
                const userPlan = document.getElementById('userPlan');
                if (userInfo) userInfo.innerHTML = 'BRAK DANYCH';
                if (userPlan) userPlan.innerHTML = 'BRAK DANYCH';
                updateMonitor();
                return;
            }
            
            let user;
            try {
                user = JSON.parse(userData);
            } catch (e) {
                console.error('‚ùå ULTIMATE SYNC: Error parsing user data:', e);
                log('‚ùå B≈ÅƒÑD PARSOWANIA: ' + e.message);
                return;
            }
            
            console.log('üéØ ULTIMATE SYNC: Fresh user data:', user);
            log('üéØ DANE U≈ªYTKOWNIKA: ' + JSON.stringify(user));
            
            const userInfo = document.getElementById('userWelcome');
            const userPlan = document.getElementById('userPlan');
            
            // Force clear and rebuild
            if (userInfo) {
                userInfo.innerHTML = '';
                const welcomeText = `<span style="color: #00ff00;">üëã Witaj, ${user.name || user.email}!</span>`;
                userInfo.innerHTML = welcomeText;
                console.log('‚úÖ ULTIMATE SYNC: Set userWelcome to:', welcomeText);
                log('‚úÖ userWelcome: ' + welcomeText);
            }
            
            if (userPlan) {
                userPlan.innerHTML = '';
                const planIcon = user.plan === 'Enterprise' ? 'üíé' : 
                                user.plan === 'Business' ? 'üè¢' : 
                                user.plan === 'Premium' ? '‚≠ê' : 'üÜì';
                const planText = `<span style="color: #00fff7;">üìã ${planIcon} ${user.plan || 'FREE'}</span>`;
                userPlan.innerHTML = planText;
                console.log('‚úÖ ULTIMATE SYNC: Set userPlan to:', planText);
                log('‚úÖ userPlan: ' + planText);
            }
            
            // Force DOM refresh
            if (userInfo) {
                userInfo.style.display = 'none';
                setTimeout(() => userInfo.style.display = '', 10);
            }
            if (userPlan) {
                userPlan.style.display = 'none';
                setTimeout(() => userPlan.style.display = '', 10);
            }
            
            log('üéâ SYNCHRONIZACJA ZAKO≈ÉCZONA: ' + user.plan);
            updateMonitor();
        }
        
        // Test functions
        function testUltimateSync(plan) {
            log('üß™ TEST: Ustawianie planu ' + plan);
            const userData = {
                email: 'test@ecvjob.pl',
                name: 'Test User',
                plan: plan,
                timestamp: new Date().toISOString()
            };
            
            sessionStorage.setItem('currentUser', JSON.stringify(userData));
            log('üíæ Zapisano dane: ' + JSON.stringify(userData));
            
            setTimeout(ultimatePlanSync, 50);
        }
        
        function createMismatch() {
            log('‚ö†Ô∏è TWORZENIE NIEZGODNO≈öCI...');
            
            // Set data to Enterprise
            const userData = {
                email: 'test@ecvjob.pl',
                name: 'Test User',
                plan: 'Enterprise',
                timestamp: new Date().toISOString()
            };
            sessionStorage.setItem('currentUser', JSON.stringify(userData));
            
            // But manually set display to Premium
            const userPlan = document.getElementById('userPlan');
            if (userPlan) {
                userPlan.innerHTML = '<span style="color: #00fff7;">üìã ‚≠ê Premium</span>';
            }
            
            log('‚ö†Ô∏è NIEZGODNO≈öƒÜ STWORZONA:');
            log('  - Dane m√≥wiƒÖ: Enterprise');
            log('  - Wy≈õwietlacz pokazuje: Premium');
            
            updateMonitor();
            
            // Auto-detect and fix after 3 seconds
            setTimeout(() => {
                log('üîÑ AUTO-DETEKCJA NIEZGODNO≈öCI...');
                detectAndFixMismatch();
            }, 3000);
        }
        
        function detectAndFixMismatch() {
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) return;
            
            const user = JSON.parse(userData);
            const userPlan = document.getElementById('userPlan');
            
            if (userPlan && !userPlan.innerHTML.includes(user.plan)) {
                logMismatch('WYKRYTO NIEZGODNO≈öƒÜ!');
                logMismatch('Dane: ' + user.plan);
                logMismatch('Wy≈õwietlacz: ' + userPlan.innerHTML);
                logMismatch('Naprawiam przez ultimatePlanSync...');
                
                ultimatePlanSync();
                
                setTimeout(() => {
                    logMismatch('NAPRAWIONO: ' + userPlan.innerHTML);
                }, 100);
            }
        }
        
        function forcePlanSync() {
            log('üîÑ WYMUSZANIE ULTIMATNEJ SYNCHRONIZACJI...');
            ultimatePlanSync();
        }
        
        function debugUserState() {
            const userData = sessionStorage.getItem('currentUser');
            const userInfo = document.getElementById('userWelcome');
            const userPlan = document.getElementById('userPlan');
            
            log('=== DEBUG STATE ===');
            log('Data: ' + (userData || 'BRAK'));
            if (userData) {
                const user = JSON.parse(userData);
                log('Plan z danych: ' + user.plan);
            }
            log('userWelcome: ' + (userInfo?.innerHTML || 'BRAK'));
            log('userPlan: ' + (userPlan?.innerHTML || 'BRAK'));
            log('===================');
        }
        
        function clearData() {
            sessionStorage.removeItem('currentUser');
            log('üóëÔ∏è DANE WYCZYSZCZONE');
            ultimatePlanSync();
        }
        
        // Logging functions
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(message);
        }
        
        function logMismatch(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('mismatchLog');
            const currentLog = logDiv.innerHTML;
            logDiv.innerHTML = `[${timestamp}] ${message}\n${currentLog}`;
            logDiv.className = 'debug-output highlight-mismatch';
        }
        
        function updateMonitor() {
            const userData = sessionStorage.getItem('currentUser');
            const userWelcome = document.getElementById('userWelcome');
            const userPlan = document.getElementById('userPlan');
            
            let status = `TIMESTAMP: ${new Date().toLocaleTimeString()}\n`;
            status += `DANE: ${userData ? 'OBECNE' : 'BRAK'}\n`;
            
            if (userData) {
                const user = JSON.parse(userData);
                status += `PLAN Z DANYCH: ${user.plan || 'BRAK'}\n`;
            }
            
            status += `\nWY≈öWIETLACZE:\n`;
            status += `userWelcome: ${userWelcome?.innerHTML || 'BRAK'}\n`;
            status += `userPlan: ${userPlan?.innerHTML || 'BRAK'}\n`;
            
            // Check for mismatch
            if (userData) {
                const user = JSON.parse(userData);
                const planDisplay = userPlan?.innerHTML || '';
                if (planDisplay && !planDisplay.includes(user.plan)) {
                    status += `\n‚ö†Ô∏è NIEZGODNO≈öƒÜ WYKRYTA!\n`;
                    status += `Dane: ${user.plan}\n`;
                    status += `Wy≈õwietlacz: ${planDisplay}\n`;
                }
            }
            
            document.getElementById('liveMonitor').textContent = status;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ STRONA ZA≈ÅADOWANA');
            ultimatePlanSync();
            
            // Update monitor every second
            setInterval(updateMonitor, 1000);
            
            // Auto-detect mismatches every 2 seconds
            setInterval(detectAndFixMismatch, 2000);
        });
        
        // Global access
        window.ultimatePlanSync = ultimatePlanSync;
        window.forcePlanSync = forcePlanSync;
        window.debugUserState = debugUserState;
    </script>
</body>
</html>
